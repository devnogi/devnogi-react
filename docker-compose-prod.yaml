version: "3.8"

# 운영 서버 환경용 Docker Compose 설정
# 사용법: docker-compose -f docker-compose-prod.yaml --env-file .env.prod up -d
# Nginx 프록시를 통한 프로덕션 배포

services:
  # Next.js Application
  nextjs-app:
    # Docker Hub에서 pull한 이미지 사용 (GitHub Actions에서 빌드된 이미지)
    image: ${DOCKER_USERNAME}/${DOCKER_REPO}:prod
    container_name: nextjs-app-prod
    # 외부 포트 노출 안 함 (nginx를 통해서만 접근)
    expose:
      - "3010"
    env_file:
      - .env  # 운영 환경 변수 파일 (GitHub Actions에서 생성)
    labels:
      autoheal: "true"
    environment:
      # === Application Configuration ===
      NODE_ENV: production
      PORT: 3010
      HOSTNAME: "0.0.0.0"

      # === Gateway Configuration ===
      NEXT_PUBLIC_GATEWAY_PROD_URL: ${NEXT_PUBLIC_GATEWAY_PROD_URL}
      GATEWAY_BASE_URL: ${GATEWAY_BASE_URL}

      # === API Configuration ===
      API_MOCKING: disabled
      VERCEL_ENV: production

    restart: always

    # 운영 서버용 리소스 제한
    deploy:
      resources:
        limits:
          cpus: "${DOCKER_CPU_LIMIT:-2.0}"
          memory: ${DOCKER_MEMORY_LIMIT:-2g}
        reservations:
          cpus: "${DOCKER_CPU_RESERVATION:-1.0}"
          memory: ${DOCKER_MEMORY_RESERVATION:-1g}

    networks:
      - nextjs-network

    # Health Check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3010/api/health"]
      interval: ${HEALTHCHECK_INTERVAL:-30s}
      timeout: ${HEALTHCHECK_TIMEOUT:-10s}
      retries: ${HEALTHCHECK_RETRIES:-5}
      start_period: ${HEALTHCHECK_START_PERIOD:-120s}

    logging:
      driver: "json-file"
      options:
        max-size: ${LOGGING_MAX_SIZE:-50m}
        max-file: "${LOGGING_MAX_FILE:-10}"

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy-prod
    ports:
      - "${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - nextjs-app
    restart: always
    networks:
      - nextjs-network
    labels:
      autoheal: "true"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 128m
        reservations:
          memory: 64m
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"

  # Autoheal: unhealthy 컨테이너 자동 재시작
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal-nextjs-prod
    restart: unless-stopped
    environment:
      AUTOHEAL_INTERVAL: ${AUTOHEAL_INTERVAL:-60}
      AUTOHEAL_START_PERIOD: ${AUTOHEAL_START_PERIOD:-300}
      AUTOHEAL_DEFAULT_STOP_TIMEOUT: ${AUTOHEAL_DEFAULT_STOP_TIMEOUT:-30}
      DOCKER_SOCK: /var/run/docker.sock
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nextjs-network
    deploy:
      resources:
        limits:
          memory: ${AUTOHEAL_MEMORY_LIMIT:-50m}
        reservations:
          memory: ${AUTOHEAL_MEMORY_RESERVATION:-20m}

networks:
  nextjs-network:
    driver: bridge
